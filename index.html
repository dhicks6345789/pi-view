<!DOCTYPE html>
<!-- A simple HTML page to view a video preview, useful for using a laptop as a monitor for a Raspberry Pi.
Live version hosted at: https://www.sansay.co.uk/pi-view
More details: https://github.com/dhicks6345789/pi-view
This was very helpful in figuring out the details of how to use getUserMedia:
	https://www.digitalocean.com/community/tutorials/front-and-rear-camera-access-with-javascripts-getusermedia
-->
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>FullScreen Viewer</title>
		<style>
			#videoContainer {
				margin: 0px auto;
				width: 64%;
				height: 100%;
				border: 0px #FFF solid;
			}
			.videoUnmirrored {
				width: 100%;
				height: 100%;
				background-color: #666;
			}
			.videoMirrored {
				width: 100%;
				height: 100%;
				background-color: #666;
				-webkit-transform: scaleX(-1);
				transform: scaleX(-1);
			}
		</style>
		<script>
			var video;
			var videoDevices;
			var videoMirrored;
			var currentVideoStream;
			var currentDeviceNumber;

			// This is where main executation starts, when the page is loaded and ready.
			async function onPageLoad() {
				video = document.querySelector("#videoElement");
				videoMirrored = false;
				currentDeviceNumber = 0;
				currentVideoStream = "";
				// Get a list of available media input/output devices...
				devices = await navigator.mediaDevices.enumerateDevices();
				// ...and trim that list down to just video cameras.
				videoDevices = devices.filter(device => device.kind === 'videoinput');
				startVideo(currentDeviceNumber);
			}
			
			// Connect to a specific camera.
			function startVideo(videoDeviceNumber) {
				if (navigator.mediaDevices.getUserMedia) {
					// We set the mediaDevice constraints to an "ideal" 4K resolution, the browser will simply scale down to the best resolution available.
					navigator.mediaDevices.getUserMedia({video:{width:{ideal:4096},height:{ideal:2160},deviceId:{exact:videoDevices[currentDeviceNumber]["deviceId"]}}})
					.then(function (stream) {
						video.srcObject = stream;
						currentVideoStream = stream;
					})
					.catch(function (theError) {
						console.log(theError);
					});
				}
			}
			
			// Called when the user clicks the "Full Screen" button.
			function openFullscreen() {
				if (video.requestFullscreen) {
					video.requestFullscreen();
				} else if (video.webkitRequestFullscreen) { /* Safari */
					video.webkitRequestFullscreen();
				} else if (video.msRequestFullscreen) { /* IE11 */
					video.msRequestFullscreen();
				}
			}
			
			// Switches the input to the next camera in the list, or goes back round to the first one if we've hit the end of the list.
			function changeInput() {
				currentVideoStream.getTracks().forEach(function(track) {
					track.stop();
				});
				video.srcObject = null;
				currentDeviceNumber = currentDeviceNumber + 1;
				if (currentDeviceNumber == videoDevices.length) {
					currentDeviceNumber = 0;
				}
				startVideo(currentDeviceNumber);
			}
			
			// Mirror / unmirror the video preview pane.
			function setMirror() {
				if (videoMirrored) {
					videoMirrored = false;
					video.className = "videoUnmirrored";
					console.log("Now not mirrored.");
				} else {
					videoMirrored = true;
					video.className = "videoMirrored";
					console.log("Now mirrored.");
				}
			}
		</script>
	</head>
	<!-- The (very few) HTML elements that make up the page - two buttons and a video preview window. -->
	<body onload="onPageLoad()">
		<div style="text-align:center;">
			<button onclick="openFullscreen();">Full Screen</button>
			<button onclick="changeInput();">Change Input</button>
			<button onclick="setMirror();">Mirror Video</button>
		</div>
		<div id="videoContainer">
			<video autoplay="true" id="videoElement" class="videoUnmirrored"></video>
		</div>
		<div style="text-align:center;">
			Documentation and source code available on <a href="https://github.com/dhicks6345789/pi-view">Github</a>.
		</div>
	</body>
</html>
